

// ==UserScript==

// @name         WorkFlowy Reminder (Improved)

// @namespace    http://tampermonkey.net/

// @version      2.9.0

// @description  ä¸ºWorkFlowyæ·»åŠ å®šæ—¶æé†’åŠŸèƒ½ï¼ˆæ”¹è¿›ç‰ˆï¼‰- å¢åŠ UIäº¤äº’ä¼˜åŒ–

// @author       Your name

// @match        https://workflowy.com/*

// @grant        GM_notification

// @grant        GM_addStyle

// ==/UserScript==

(function() {

    'use strict';

    GM_addStyle(`

    .reminder-panel {

        position: fixed;

        right: -319px;

        top: 46px; /* ä¸ WorkFlowy å¤´éƒ¨å¯¹é½ */

        height: calc(100vh - 46px);

        width: 319px;

        background: #2B3135;

        border-left: 1px solid #5c6062;

        z-index: 100;

        display: flex;

        flex-direction: column;

        transition: transform 0.3s ease;

    }

    .panel-header {

        padding: 12px;

        flex-shrink: 0;

    }

    .panel-content {

        flex: 1;

        overflow-y: auto;

        padding: 0 12px;

    }

    .panel-content::-webkit-scrollbar {

        width: 8px;

    }

    .panel-content::-webkit-scrollbar-track {

        background: #353c3f;

    }

    .panel-content::-webkit-scrollbar-thumb {

        background: #636a6d;

        border-radius: 4px;

    }

    .reminder-panel.visible {

        transform: translateX(-319px);

    }

    /* åŒæ—¶æ›´æ–°å†…å®¹åŒºåŸŸçš„å®½åº¦å¤„ç†é€»è¾‘ */

    .reminder-panel.visible ~ #content {

        padding-right: 319px;

    }

    #content {

        transition: padding-right 0.3s ease;

    }

    #content.panel-visible {

        padding-right: 319px; /* æ›´æ–°å†…å®¹åŒºåŸŸçš„ padding */

    }

    /* å¿«æ·é”®æç¤ºæ ·å¼ */

    #shortcut-toast {

        position: fixed;

        top: 20px;

        left: 50%;

        transform: translateX(-50%) translateY(-100%);

        background: rgba(0, 0, 0, 0.8);

        color: white;

        padding: 8px 16px;

        border-radius: 4px;

        font-size: 14px;

        opacity: 0;

        visibility: hidden;

        transition: all 0.3s ease;

        z-index: 10001;

        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;

    }

    #shortcut-toast.show {

        transform: translateX(-50%) translateY(0);

        opacity: 1;

        visibility: visible;

    }

    /* æ›´æ–°åˆ‡æ¢æŒ‰é’®æ ·å¼ */

    .reminder-toggle {

        position: fixed;

        right: 20px;

        top: 60px;

        background: #2B3135;

        border: none;

        padding: 8px;

        border-radius: 50%;

        cursor: pointer;

        z-index: 101;

        width: 32px;

        height: 32px;

        display: flex;

        align-items: center;

        justify-content: center;

        transition: all 0.3s ease;

    }

    .reminder-toggle:hover {

        background: #363b3f;

    }

    /* ç®­å¤´æ—‹è½¬ */

    .reminder-toggle.active .toggle-arrow {

        transform: rotate(180deg);

    }

    /* ä¿æŒå¿«æ·é”®æç¤º */

    .reminder-toggle::after {

        content: 'Alt + W';

        position: absolute;

        bottom: -20px;

        left: 50%;

        transform: translateX(-50%);

        font-size: 11px;

        color: #999;

        white-space: nowrap;

        opacity: 0;

        transition: opacity 0.2s ease;

        pointer-events: none;

    }

    .reminder-toggle:hover::after {

        opacity: 1;

    }

    /* ç®­å¤´å›¾æ ‡æ ·å¼ */

    .toggle-arrow {

        width: 16px;

        height: 16px;

        color: #e8e8e8;

        transition: transform 0.3s ease;

    }

    .mode-switch {

        display: flex;

        background: #2a3135;

        border-radius: 10px;

        padding: 6px;

        margin-bottom: 12px;

    }

    .mode-btn {

        flex: 1;

        padding: 6px 10px;

        border: none;

        background: transparent;

        color: #e8e8e8;

        cursor: pointer;

        border-radius: 4px;

        transition: all 0.3s;

        font-size: 14px;

        margin: 2px;

    }

    .mode-btn.active,.mode-btn:hover {

        background: #3A3F42;

        box-shadow: 0 2px 4px rgba(0,0,0,0.2);

    }

    .planner-link {

        display: block;

        color: #a8a8a8;

        font-size: 14px;

        text-decoration: none;

        padding: 8px;

        border-radius: 4px;

        margin-bottom: 20px;

        background: #2a3135;

        transition: all 0.3s;

    }

    .planner-link:hover {

        background: #33373A;

        color: #e8e8e8;

    }

    .reminder-block {

        margin-bottom: 16px;

        position: relative;

        z-index: 1;

    }

    .reminder-block-title {

        color: #d9dbdb;

        font-size: 14px;

        margin-bottom: 8px;

        padding: 8px;

        background: #363b3e;

        border-radius: 4px;

        font-weight: bold;

    }

    .panel-title {

        line-height: 1.2em;

        margin-bottom: 12px;

    }

    .reminder-item {

        padding: 12px 12px 0;

        margin-bottom: 12px;

        border-radius: 8px;

        position: relative;

        transition: all 0.3s;

        flex-direction: column;

        align-items: stretch;

        overflow: hidden;

        display: flex;

        border: 1px solid #555;

        transform: translate(0, 0);

        z-index: 1;

    }

    .reminder-item:hover {

        background:#2a3135;

        border-color:#2a3135;

    }

    .reminder-item.visited {

        opacity: 0.6;

    }

    

    .reminder-item-content {

        display: flex;

        align-items: center;

        margin-bottom: 12px;

        gap: 4px;

    }

    .reminder-item-name {

        flex: 1;

        min-width: 0;

        overflow: hidden;

        text-overflow: ellipsis;

        cursor: pointer;

        line-height: 1.2em;

    }

    .reminder-actions {

        display: flex;

        background: #333638;

        height: 0;

        overflow: hidden;

        transition: height 0.3s ease-in-out;

        margin: 0 -12px;

        width: calc(100% + 24px);

    }

    .reminder-item:hover .reminder-actions {

        height: 35px;

    }

    .reminder-actions button {

        flex: 1;

        height: 35px;

        border: none;

        background: #2a3135;

        color: #d9dbdb;

        cursor: pointer;

        transition: background-color 0.2s ease;

        font-size: 14px;

        padding: 0;

        margin: 0;

        min-width: 0;

        border-radius: 0;

    }

    .reminder-actions button:hover {

        background: #33373A;

    }

     .clear-all-container {

        padding: 12px;

        background: #353c3f;

        border-top: 1px solid #444;

        flex-shrink: 0;

    }

    /* Workflowyå®˜ç½‘å¼¹å‡ºå¿«æ·é”®é¢æ¿æ ·å¼ */

    .right-bar div:nth - child(1) {

        width: 300px;

    }

    .clear-all-btn {

        width: 100%;

        height: 32px;

        background: #42484b;

        color: #e8e8e8;

        border: none;

        border-radius: 22px;

        cursor: pointer;

        font-size: 14px;

        transition: all 0.3s;

    }

    .clear-all-btn:hover {

        background: #d9534f;

    }

        .reminder-list {

            margin-bottom: 60px;

        }

    .no-reminders {

        text-align: center;

        color: #a8a8a8;

        font-size: 14px;

        padding: 20px;

        line-height: 1.6;

    }

    .panel-content {

        padding-bottom: 80px;

    }

    .version-tag {

        font-size: 12px;

        color: #8b9398;

        font-weight: normal;

        margin-left: 8px;

        padding: 2px 6px;

        background: #2a3135;

        border-radius: 10px;

        display: inline-block;

        vertical-align: middle;

        line-height: 1.5;

    }

    .has-mirrors {

        position: relative;

    }

    .has-mirrors::before {

        content: '';

        position: absolute;

        left: 0;

        top: 0;

        bottom: 0;

        width: 3px;

        background: #4a9eff;

        border-radius: 3px 0 0 3px;

        opacity: 0.6;

    }

     .reminder-action-btn {

        background: transparent;

        border: none;

        color: #d9dbdb;

        cursor: pointer;

        padding: 4px 8px;

        font-size: 12px;

        border-radius: 4px;

        transition: all 0.2s ease;

    }

    .reminder-action-btn:hover {

        background: #33373A;

    }

    .reminder-action-btn.complete {

        color: #28a745;

    }

    .reminder-action-btn.delete {

        color: #dc3545;

    }

    .reminder-item.completed {

        opacity: 0.6;

    }

    .reminder-item.completed .reminder-item-name {

        text-decoration: line-through;

    }

    `);

    const SCRIPT_VERSION = GM_info.script.version;

    const TARGET_NODE_ID = '8220a888febe'; // DailyPlannerç›®æ ‡èŠ‚ç‚¹ID

    let reminders = JSON.parse(localStorage.getItem('workflowy_reminders') || '{}');

    let currentMode = 'scan';

    let visitedItems = JSON.parse(localStorage.getItem('workflowy_visited_items') || '[]');

    function normalizeReminderText(text) {

        return text.trim().replace(/\s+/g, ' ');

    }

    

    function extractTimeInfo(text) {

        const timeMatch = text.match(/@(\d{1,2}:\d{2})/);

        return timeMatch ? timeMatch[1] : null;

    }

    

    function extractReminderContent(text) {

        return normalizeReminderText(text

            .replace(/@\d{1,2}:\d{2}/, '')

            .replace(/#remind/, '')

            .replace(/#æé†’/, '')

            .replace(/#ç¨åå¤„ç†/, '')

            .replace(/#01æ¯æ—¥æ¨è¿›/, '')

            .trim());

    }

    

    function isDuplicateReminder(newReminder, existingReminders) {

        const newContent = extractReminderContent(newReminder.name);

        const newTime = extractTimeInfo(newReminder.name);

        return Object.values(existingReminders).some(reminder => {

            const existingContent = extractReminderContent(reminder.name);

            const existingTime = extractTimeInfo(reminder.name);

            return newContent === existingContent && newTime === existingTime;

        });

    }

    

    function waitForWF() {

        if(typeof WF !== 'undefined') {

            console.log('WorkFlowy API åŠ è½½å®Œæˆ');

            initReminder();

        } else {

            console.log('ç­‰å¾… WorkFlowy API...');

            setTimeout(waitForWF, 100);

        }

    }

    function initReminder() {

        // åˆ›å»ºæé†’é¢æ¿

        const panel = document.createElement('div');

        panel.className = 'reminder-panel';

        panel.innerHTML = `

            <div class="panel-header">

                <h1>

                    Workflowy Forwarder

                    <span class="version-tag">v${SCRIPT_VERSION}</span>

                </h1>

                <div class="mode-switch">

                    <button class="mode-btn active" id="scan-reminders">DailyPlanner</button>

                    <button class="mode-btn" id="follow-reminders">Target</button>

                    <button class="mode-btn" id="collect-reminders">Collector</button>

                </div>

                <a href="https://workflowy.com/#/${TARGET_NODE_ID}" class="planner-link">

                    ğŸ”— è¿›å…¥è®¡åˆ’

                </a>

            </div>

            <div class="panel-content">

                <div class="reminder-list" id="reminder-list"></div>

            </div>

            <div class="clear-all-container">

                <button class="clear-all-btn" id="clear-all">æ¸…é™¤æ‰€æœ‰ç¬”è®°</button>

            </div>

        `;

    

        document.body.appendChild(panel);

        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬

        document.addEventListener('keydown', handleKeyPress);

        // åˆå§‹åŒ–å…¶ä»–äº‹ä»¶ç›‘å¬

        document.getElementById('scan-reminders').onclick = () => {

            currentMode = 'scan';

            scanReminders();

            updateButtonStyles();

        };

        // æ·»åŠ æŠ˜å æŒ‰é’®

        const toggleBtn = document.createElement('button');

        toggleBtn.className = 'reminder-toggle';

        toggleBtn.innerHTML = `

            <svg aria-hidden="true" focusable="false" class="toggle-arrow" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">

                <path fill="currentColor" d="M4.7 244.7c-6.2 6.2-6.2 16.4 0 22.6l176 176c6.2 6.2 16.4 6.2 22.6 0s6.2-16.4 0-22.6L54.6 272 432 272c8.8 0 16-7.2 16-16s-7.2-16-16-16L54.6 240 203.3 91.3c6.2-6.2 6.2-16.4 0-22.6s-16.4-6.2-22.6 0l-176 176z"></path>

            </svg>

        `;

        document.body.appendChild(toggleBtn);

    

        // å¤„ç†å†…å®¹åŒºåŸŸçš„padding

        function updateContentPadding() {

            const content = document.getElementById('content');

            if (!content) return;

            

            if (panel.classList.contains('visible')) {

                content.style.paddingRight = '336px';

            } else {

                content.style.paddingRight = '0';

            }

        }

    

        // æ·»åŠ äº‹ä»¶ç›‘å¬

        toggleBtn.onclick = () => {

            panel.classList.toggle('visible');

            toggleBtn.classList.toggle('active');

            updateContentPadding();

        };

        document.getElementById('scan-reminders').onclick = () => {

            currentMode = 'scan';

            scanReminders();

            updateButtonStyles();

        };

        document.getElementById('follow-reminders').onclick = () => {

            currentMode = 'follow';

            followReminders();

            updateButtonStyles();

        };

        document.getElementById('collect-reminders').onclick = () => {

            currentMode = 'collect';

            collectReminders();

            updateButtonStyles();

        };

        document.getElementById('clear-all').onclick = clearAllReminders;

        updateButtonStyles();

        scanReminders();

        updateContentPadding();

        // è®¾ç½®å®šæ—¶åˆ·æ–°

        setInterval(() => {

            if (currentMode === 'scan') {

                scanReminders();

            }

        }, 60000);

        

    }

    // å¤„ç†é”®ç›˜äº‹ä»¶

    function handleKeyPress(event) {

        // Alt + F

        if (event.altKey && event.code === 'KeyF') {

            event.preventDefault();

            togglePanel();

            showShortcutToast();

        }

    }

    // æ˜¾ç¤ºå¿«æ·é”®æç¤º

    function showShortcutToast() {

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æç¤ºå…ƒç´ 

        let toast = document.getElementById('shortcut-toast');

        if (!toast) {

            toast = document.createElement('div');

            toast.id = 'shortcut-toast';

            document.body.appendChild(toast);

        }

        // æ›´æ–°æç¤ºå†…å®¹

        toast.textContent = 'é¢æ¿å·²åˆ‡æ¢ (Alt + F)';

        toast.classList.add('show');

        // 2ç§’åéšè—æç¤º

        setTimeout(() => {

            toast.classList.remove('show');

        }, 2000);

    }

    

    function updateLastRefreshTime() {

        const now = new Date();

        const timeStr = now.toLocaleTimeString();

        const refreshBtn = document.getElementById('refresh-btn');

        if (refreshBtn) {

            refreshBtn.title = `æœ€ååˆ·æ–°: ${timeStr}`;

        }

    }

    

    function updateButtonStyles() {

        const scanBtn = document.getElementById('scan-reminders');

        const followBtn = document.getElementById('follow-reminders');

        const collectBtn = document.getElementById('collect-reminders');

    

        scanBtn.classList.toggle('active', currentMode === 'scan');

        followBtn.classList.toggle('active', currentMode === 'follow');

        collectBtn.classList.toggle('active', currentMode === 'collect');

    

        // æ›´æ–°é“¾æ¥çš„æ˜¾ç¤º

        const plannerLink = document.querySelector('.planner-link');

        if (plannerLink) {

            plannerLink.style.display = currentMode === 'scan' ? 'block' : 'none';

        }

    }

    

    function togglePanel() {

        const panel = document.querySelector('.reminder-panel');

        const toggleBtn = document.querySelector('.reminder-toggle');

        const content = document.getElementById('content');

        

        if (panel && toggleBtn) {

            panel.classList.toggle('visible');

            toggleBtn.classList.toggle('active');

            

            if (content) {

                content.style.paddingRight = panel.classList.contains('visible') ? '319px' : '0';

            }

        }

    }

    function scanReminders() {

        const targetNode = WF.getItemById(TARGET_NODE_ID);

        if (!targetNode) {

            console.log('æœªæ‰¾åˆ°æŒ‡å®šèŠ‚ç‚¹');

            return;

        }

        const newReminders = {};

        const firstLevelNodes = targetNode.getChildren();

        firstLevelNodes.forEach(node => {

            const name = node.getNameInPlainText();

            const id = node.getId();

            if (name.toLowerCase().includes('references')) {

                return;

            }

            const timeMatch = name.match(/^(\d{2})/);

            if (timeMatch) {

                const number = parseInt(timeMatch[1]);

                if (number >= 5 && number <= 22) {

                    const children = node.getChildren();

                    children.forEach(child => {

                        const childName = child.getNameInPlainText();

                        if (childName.trim() && !childName.toLowerCase().includes('references')) {

                            const reminderTime = new Date();

                            reminderTime.setHours(number, 0, 0, 0);

                            

                            // è·å–èŠ‚ç‚¹å®ŒæˆçŠ¶æ€

                            const completed = WF.getItemById(child.getId())?.isCompleted() || false;

                            const newReminder = {

                                id: child.getId(),

                                name: childName,

                                parentName: name,

                                parentId: id,

                                time: reminderTime.getTime(),

                                notified: false,

                                mode: 'scan',

                                url: `https://workflowy.com/#/${child.getId()}`,

                                completed: completed  // ä½¿ç”¨å®é™…çš„å®ŒæˆçŠ¶æ€

                            };

                            newReminders[child.getId()] = newReminder;

                        }

                    });

                }

            }

        });

        // åˆå¹¶æé†’æ—¶ä¿ç•™éscanæ¨¡å¼çš„æé†’

        reminders = Object.fromEntries(

            Object.entries(reminders)

                .filter(([_, r]) => r.mode !== 'scan')

                .concat(Object.entries(newReminders))

        );

        saveReminders();

        updateReminderList();

    }

    

    function followReminders() {

        const newReminders = {};

        const targetNodeIds = ['6280897d3c65', '3b7e610683fe'];

        const tempReminders = new Map();

        for (const targetNodeId of targetNodeIds) {

            const targetNode = WF.getItemById(targetNodeId);

            if (!targetNode) {

                console.log(`æœªæ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹: ${targetNodeId}`);

                continue;

            }

            function processItem(item) {

                const name = item.getNameInPlainText();

                const note = item.getNoteInPlainText();

                const id = item.getId();

                const element = item.getElement();

                const hasMirrors = element && element.closest('.project').classList.contains('hasMirrors');

                if (!name.includes('#index') && !note.includes('#index') && id !== targetNodeId) {

                    if (name.includes('#01æ¯æ—¥æ¨è¿›') || note.includes('#01æ¯æ—¥æ¨è¿›')) {

                        const reminderText = note.includes('#01æ¯æ—¥æ¨è¿›') ? note : name;

                        const normalizedContent = extractReminderContent(reminderText);

                        

                        // è·å–å®é™…çš„å®ŒæˆçŠ¶æ€

                        const wfItem = WF.getItemById(id);

                        const completed = wfItem ? wfItem.isCompleted() : false;

                        const newReminder = {

                            id: id,

                            name: reminderText,

                            originalName: name,

                            hasNoteTag: note.includes('#01æ¯æ—¥æ¨è¿›'),

                            time: new Date().getTime(),

                            notified: false,

                            mode: 'follow',

                            url: `https://workflowy.com/#/${id}`,

                            hasMirrors: hasMirrors,

                            completed: completed  // ä½¿ç”¨å®é™…çš„å®ŒæˆçŠ¶æ€

                        };

                        if (note.includes('#01æ¯æ—¥æ¨è¿›')) {

                            newReminder.displayName = `${name} `;

                        } else {

                            newReminder.displayName = name;

                        }

                        const existingReminder = tempReminders.get(normalizedContent);

                        if (!existingReminder || (hasMirrors && !existingReminder.hasMirrors)) {

                            tempReminders.set(normalizedContent, newReminder);

                        }

                    }

                }

                item.getChildren().forEach(child => processItem(child));

            }

            processItem(targetNode);

        }

        // å°†ç­›é€‰åçš„æé†’åŠ å…¥åˆ°newReminderså¯¹è±¡

        for (const reminder of tempReminders.values()) {

            newReminders[reminder.id] = reminder;

        }

        // æ›´æ–°å…¨å±€æé†’å¯¹è±¡

        reminders = Object.fromEntries(

            Object.entries(reminders)

                .filter(([_, r]) => r.mode !== 'follow')

                .concat(Object.entries(newReminders))

        );

        saveReminders();

        updateReminderList();

    }

    

    function collectReminders() {

        const newReminders = {};

        const inboxId = '17cfc44d9b20';

        const inboxItem = WF.getItemById(inboxId);

        if (!inboxItem) {

            alert('æœªæ‰¾åˆ°æ”¶ä»¶ç®±èŠ‚ç‚¹ï¼');

            return;

        }

        // ä»å·²æœ‰çš„æé†’ä¸­è¯»å–åˆ›å»ºæ—¶é—´

        const existingReminders = Object.fromEntries(

            Object.entries(reminders)

                .filter(([_, r]) => r.mode === 'collect')

        );

        // ç›´æ¥è·å–ç¬¬ä¸€çº§å­èŠ‚ç‚¹

        const firstLevelNodes = inboxItem.getChildren();

        firstLevelNodes.forEach(item => {

            const name = item.getNameInPlainText();

            const id = item.getId();

            if (!name.includes('#index') && id !== inboxId) {

                if (name.includes('#ç¨åå¤„ç†')) {

                    // è·å–å®é™…çš„å®ŒæˆçŠ¶æ€

                    const wfItem = WF.getItemById(id);

                    const completed = wfItem ? wfItem.isCompleted() : false;

                    

                    // å¦‚æœæ˜¯å·²å­˜åœ¨çš„æé†’ï¼Œä¿ç•™åŸæœ‰çš„åˆ›å»ºæ—¶é—´

                    const existingReminder = existingReminders[id];

                    const creationTime = existingReminder ? existingReminder.creationTime : Date.now();

                    const newReminder = {

                        id: id,

                        name: name,

                        time: item.getLastModifiedDate().getTime(),

                        creationTime: creationTime,

                        notified: false,

                        mode: 'collect',

                        url: `https://workflowy.com/#/${id}`,

                        hasChildren: item.getChildren().length > 0,

                        completed: completed  // ä½¿ç”¨å®é™…çš„å®ŒæˆçŠ¶æ€

                    };

                    newReminders[id] = newReminder;

                }

            }

        });

        // æ›´æ–°æé†’åˆ—è¡¨

        reminders = Object.fromEntries(

            Object.entries(reminders)

                .filter(([_, r]) => r.mode !== 'collect')

                .concat(Object.entries(newReminders))

        );

        saveReminders();

        updateReminderList();

    }

    

    function createReminderItem(reminder) {

        const isCompleted = reminder.completed || false;

        const isVisited = currentMode === 'collect' && visitedItems.includes(reminder.id);

        let displayText = reminder.name;

        if (reminder.mode === 'follow' && reminder.displayName) {

            displayText = reminder.displayName;

        }

    

        return `

        <div class="reminder-item ${isVisited ? 'visited' : ''} ${reminder.hasMirrors ? 'has-mirrors' : ''} ${isCompleted ? 'completed' : ''}"

             data-id="${reminder.id}"

             data-mode="${reminder.mode}">

            <div class="reminder-item-content">

                <span class="reminder-item-name" onclick="WF.getItemById('${reminder.id}') && WF.zoomTo(WF.getItemById('${reminder.id}'))">${displayText}</span>

            </div>

            <div class="reminder-actions">

                <button class="reminder-action-btn complete" data-id="${reminder.id}">

                    ${isCompleted ? 'å–æ¶ˆå®Œæˆ' : 'å®Œæˆ'}

                </button>

                <button class="copy-btn" data-content="${reminder.url}">å¤åˆ¶é“¾æ¥</button>

                <button class="reminder-action-btn delete" data-id="${reminder.id}">åˆ é™¤</button>

            </div>

        </div>`;

    }

    

    function updateReminderList() {

        const listElement = document.getElementById('reminder-list');

        if (!listElement) return;

    

        const currentReminders = Object.values(reminders).filter(r => r.mode === currentMode);

    

        if (currentMode === 'scan') {

            const remindersByParent = {};

    

            currentReminders.forEach(reminder => {

                const parentId = reminder.parentId;

                if (!remindersByParent[parentId]) {

                    remindersByParent[parentId] = {

                        name: reminder.parentName,

                        time: reminder.time,

                        items: []

                    };

                }

                remindersByParent[parentId].items.push(reminder);

            });

    

            const blocks = Object.entries(remindersByParent)

                .sort(([_, a], [__, b]) => a.time - b.time)

                .map(([parentId, block]) => {

                    const items = block.items

                        .map(reminder => createReminderItem(reminder))

                        .join('');

    

                    return `

                        <div class="reminder-block">

                            <div class="reminder-block-title">${block.name}</div>

                            ${items}

                        </div>

                    `;

                }).join('');

    

            listElement.innerHTML = blocks || '<div class="no-reminders">æš‚æ— æ—¶é—´å—å†…å®¹<br>æ—¶é—´æ ¼å¼ï¼š05-22</div>';

        } else {

            let items = currentReminders;

            

            if (currentMode === 'collect') {

                // ä½¿ç”¨åˆ›å»ºæ—¶é—´è¿›è¡Œæ’åº

                items = items.sort((a, b) => {

                    return b.creationTime - a.creationTime; // ä»æ–°åˆ°æ—§æ’åº

                });

            } else {

                items = items.sort((a, b) => 

                    extractReminderContent(a.name).localeCompare(extractReminderContent(b.name))

                );

            }

    

            listElement.innerHTML = items

                .map(reminder => createReminderItem(reminder))

                .join('') || 

                `<div class="no-reminders">æš‚æ— ${

                    currentMode === 'follow' ? 

                    'è·Ÿè¿›äº‹é¡¹<br>ä½¿ç”¨æ ¼å¼ï¼šä»»åŠ¡å†…å®¹ #01æ¯æ—¥æ¨è¿›' : 

                    'å¾…æ•´ç†äº‹é¡¹<br>ä½¿ç”¨æ ¼å¼ï¼šä»»åŠ¡å†…å®¹ #ç¨åå¤„ç†'

                }</div>`;

        }

    

        addEventListeners(listElement);

    }

    // ä¿®æ”¹äº‹ä»¶ç›‘å¬å™¨

    function addEventListeners(listElement) {

        // ç‚¹å‡»èŠ‚ç‚¹åç§°

        listElement.querySelectorAll('.reminder-item').forEach(item => {

            const nameEl = item.querySelector('.reminder-item-name');

            const id = item.dataset.id;

    

            nameEl.addEventListener('click', () => {

                if (currentMode === 'collect' && !visitedItems.includes(id)) {

                    visitedItems.push(id);

                    localStorage.setItem('workflowy_visited_items', JSON.stringify(visitedItems));

                    item.classList.add('visited');

                }

                const wfItem = WF.getItemById(id);

                if (wfItem) WF.zoomTo(wfItem);

            });

        });

    

        // å®ŒæˆæŒ‰é’®äº‹ä»¶

        listElement.querySelectorAll('.reminder-action-btn.complete').forEach(btn => {

            btn.addEventListener('click', function() {

                const id = this.dataset.id;

                const item = WF.getItemById(id);

                if (item) {

                    WF.completeItem(item);

                    const reminder = reminders[id];

                    if (reminder) {

                        reminder.completed = !reminder.completed;

                        saveReminders();

                        updateReminderList();

                    }

                }

            });

        });

    

        // å¤åˆ¶é“¾æ¥æŒ‰é’®äº‹ä»¶

        listElement.querySelectorAll('.copy-btn').forEach(btn => {

            btn.addEventListener('click', function() {

                navigator.clipboard.writeText(this.dataset.content).then(() => {

                    this.textContent = 'å·²å¤åˆ¶';

                    setTimeout(() => this.textContent = 'å¤åˆ¶é“¾æ¥', 1000);

                });

            });

        });

    

        // åˆ é™¤æŒ‰é’®äº‹ä»¶

        listElement.querySelectorAll('.reminder-action-btn.delete').forEach(btn => {

            btn.addEventListener('click', async function() {

                const id = this.dataset.id;

                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {

                    const item = WF.getItemById(id);

                    if (item) {

                        WF.editGroup(() => {

                            const currentItem = WF.currentItem();

                            const parent = item.getParent();

                            

                            WF.deleteItem(item);

                            

                            if (currentItem && (currentItem.getId() === id || isDescendant(currentItem, item))) {

                                setTimeout(() => {

                                    if (parent) {

                                        WF.zoomTo(parent);

                                    } else {

                                        WF.zoomTo(WF.rootItem());

                                    }

                                }, 100);

                            }

                            

                            delete reminders[id];

                            saveReminders();

                            updateReminderList();

                        });

                    }

                }

            });

        });

    }

    function isDescendant(possibleDescendant, ancestor) {

        let current = possibleDescendant;

        while (current) {

            if (current.getId() === ancestor.getId()) {

                return true;

            }

            current = current.getParent();

        }

        return false;

    }

    

    function deleteReminder(id) {

        // ä»æœ¬åœ°å­˜å‚¨ä¸­åˆ é™¤æé†’

        delete reminders[id];

        saveReminders();

        

        // æ›´æ–°ç•Œé¢æ˜¾ç¤º

        updateReminderList();

    }

    

    function clearAllReminders() {

        reminders = Object.fromEntries(

            Object.entries(reminders).filter(([_, r]) => r.mode !== currentMode)

        );

        saveReminders();

        updateReminderList();

    }

    function saveReminders() {

        localStorage.setItem('workflowy_reminders', JSON.stringify(reminders));

    }

    

    console.log('WorkFlowy DAILY PLANNER åŠ©æ‰‹å¯åŠ¨...');

    waitForWF();

    

    })();

